<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Admin • SaaS Control</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --border:#e5e7eb;
  --radius:22px;
  --danger:#c62828;
  --muted:#6b7280;
  --bg:#000;
  --card:#fff;
}
*{box-sizing:border-box;font-family:Inter;-webkit-tap-highlight-color:transparent}
body{margin:0;background:#000;color:#111}
.header{
  position:sticky;top:0;z-index:20;
  background:#fff;border-bottom:1px solid var(--border);
  padding:14px 18px;display:flex;align-items:center;justify-content:space-between
}
.header h1{margin:0;font-size:18px}
.container{max-width:1400px;margin:auto;padding:20px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:14px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:22px;padding:16px}
.kpi small{color:var(--muted)}
.kpi b{font-size:22px}
.filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.filters input,.filters select{
  padding:12px;border-radius:14px;border:1px solid var(--border)
}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
td{background:#fff;border:1px solid var(--border);padding:10px;border-left:none;border-right:none}
tr td:first-child{border-radius:14px 0 0 14px;border-left:1px solid var(--border)}
tr td:last-child{border-radius:0 14px 14px 0;border-right:1px solid var(--border)}
.badge{padding:4px 8px;border-radius:999px;font-size:11px;font-weight:700}
.active{background:#e8fff3;color:#16a34a}
.trial{background:#fff7ed;color:#ff6a00}
.expired{background:#ffe5e5;color:#c62828}
.btn{
  padding:8px 12px;border-radius:999px;border:1px solid var(--border);
  background:#fff;cursor:pointer;font-weight:700
}
.btn.primary{
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  border:none;color:#fff
}
.avatar{width:34px;height:34px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:center;justify-content:center;z-index:50
}
.modal .box{
  background:#fff;padding:22px;border-radius:22px;
  width:95%;max-width:820px;max-height:90vh;overflow:auto
}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.grid input,.grid select,.grid textarea{
  width:100%;padding:10px;border-radius:12px;border:1px solid var(--border)
}
.footer-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
</style>
</head>
<body>

<header class="header">
  <h1>Central Admin • SaaS</h1>
  <button class="btn primary" onclick="load()">Atualizar</button>
</header>

<div class="container">

  <div class="kpis">
    <div class="kpi"><small>Total</small><b id="k_total">0</b></div>
    <div class="kpi"><small>Ativos</small><b id="k_ativas">0</b></div>
    <div class="kpi"><small>Trials</small><b id="k_trial">0</b></div>
    <div class="kpi"><small>MRR</small><b id="k_mrr">R$ 0,00</b></div>
  </div>

  <div class="filters">
    <input id="f_busca" placeholder="Buscar..." oninput="render()">
    <select id="f_status" onchange="render()">
      <option value="">Status</option>
      <option value="active">Ativo</option>
      <option value="trial">Trial</option>
      <option value="expired">Expirado</option>
    </select>
    <select id="f_plano" onchange="render()">
      <option value="">Plano</option>
      <option value="MASTER">MASTER</option>
      <option value="BASIC">BASIC</option>
    </select>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Negócio</th>
        <th>Status</th>
        <th>Plano</th>
        <th>Valor</th>
        <th>Validade</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

</div>

<div class="modal" id="modal">
  <div class="box">
    <h3>Editar Cliente</h3>
    <div class="grid" id="form"></div>
    <div class="footer-actions">
      <button class="btn" onclick="closeModal()">Cancelar</button>
      <button class="btn primary" onclick="salvar()">Salvar</button>
    </div>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

let data = [];
let current = null;

async function load(){
  const { data:rows } = await sb.from("user_profile").select("*").order("created_at",{ascending:false});
  data = rows || [];
  calcKpis();
  render();
}
load();

function calcKpis(){
  k_total.innerText = data.length;
  k_ativas.innerText = data.filter(i=>i.assinatura_ativa).length;
  k_trial.innerText = data.filter(i=>i.status==="trial").length;
  const mrr = data.reduce((s,i)=> s + (Number(i.assinatura_valor)||0),0);
  k_mrr.innerText = mrr.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

function render(){
  const busca = f_busca.value.toLowerCase();
  const status = f_status.value;
  const plano = f_plano.value;

  const list = data.filter(i=>{
    return (!busca || JSON.stringify(i).toLowerCase().includes(busca))
      && (!status || i.status===status)
      && (!plano || i.assinatura_plano===plano);
  });

  tbody.innerHTML = list.map(i=>`
    <tr>
      <td><img class="avatar" src="${i.avatar_url||''}"> ${i.responsavel||"-"}</td>
      <td>${i.negocio||"-"}</td>
      <td><span class="badge ${i.status}">${i.status}</span></td>
      <td>${i.assinatura_plano||"-"}</td>
      <td>R$ ${i.assinatura_valor||0}</td>
      <td>${i.assinatura_valida_ate ? new Date(i.assinatura_valida_ate).toLocaleDateString() : "-"}</td>
      <td>
        <button class="btn" onclick='edit(${JSON.stringify(i)})'>Editar</button>
        <a class="btn" target="_blank" href="/${i.slug}/${i.app_path||"app.html"}">Abrir App</a>
      </td>
    </tr>
  `).join("");
}

function edit(row){
  current = row;
  form.innerHTML = Object.keys(row).map(k=>`
    <div>
      <label>${k}</label>
      <input value="${(row[k]??"").toString().replaceAll('"','&quot;')}"
        onchange="current['${k}']=this.value">
    </div>
  `).join("");
  modal.style.display="flex";
}
function closeModal(){ modal.style.display="none"; }
async function salvar(){
  await sb.from("user_profile").update(current).eq("id", current.id);
  closeModal();
  load();
}
</script>
</body>
</html>
