<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Central Admin â€¢ SaaS Control</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --bg:#000;
  --card:#fff;
  --border:#e5e7eb;
  --muted:#6b7280;
  --success:#16a34a;
  --danger:#dc2626;
  --warn:#f59e0b;
  --radius:22px;
}
*{box-sizing:border-box;font-family:Inter;-webkit-tap-highlight-color:transparent}
body{
  margin:0;background:
  radial-gradient(900px 300px at 20% -10%,rgba(255,106,0,.15),transparent 40%),#000;
}
.header{
  position:sticky;top:0;z-index:10;
  background:#fff;border-bottom:1px solid var(--border);
  padding:16px 20px;display:flex;align-items:center;justify-content:space-between
}
.header h1{margin:0;font-size:18px}
.container{max-width:1600px;margin:auto;padding:18px}
.filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
.filters input,.filters select{
  padding:12px;border-radius:999px;border:1px solid var(--border)
}

/* ðŸ‘‡ 6 colunas no desktop */
.grid{
  display:grid;
  grid-template-columns:repeat(6, 1fr);
  gap:12px;
}

/* Responsivo */
@media(max-width:1400px){
  .grid{grid-template-columns:repeat(4, 1fr);}
}
@media(max-width:1100px){
  .grid{grid-template-columns:repeat(3, 1fr);}
}
@media(max-width:800px){
  .grid{grid-template-columns:repeat(2, 1fr);}
}
@media(max-width:520px){
  .grid{grid-template-columns:1fr;}
}

.card{
  background:#fff;border-radius:22px;padding:14px;border:1px solid var(--border);
  box-shadow:0 10px 30px rgba(0,0,0,.12)
}
.top{display:flex;gap:10px;align-items:center;margin-bottom:8px}
.avatar{width:46px;height:46px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
.name{font-weight:900;font-size:14px}
.city{font-size:11px;color:var(--muted)}
.badge{padding:3px 8px;border-radius:999px;font-size:10px;font-weight:900}
.active{background:#e8fff3;color:var(--success)}
.trial{background:#fff7ed;color:var(--primary)}
.expired{background:#ffe5e5;color:var(--danger)}
.info{font-size:12px;margin-top:2px;color:#111}
.muted{color:var(--muted)}
.row{display:flex;justify-content:space-between;gap:6px;margin-top:4px;font-size:12px}
.actions{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.btn{
  padding:6px 10px;border-radius:999px;border:1px solid var(--border);
  background:#fff;cursor:pointer;font-weight:800;font-size:11px;
  display:flex;align-items:center;gap:6px;text-decoration:none;color:#111
}
.btn.primary{
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  color:#fff;border:none
}
.btn.warn{border:1px dashed var(--primary);color:var(--primary)}
.icons{display:flex;gap:6px;margin-top:6px}
.icon{
  width:28px;height:28px;border-radius:50%;
  display:grid;place-items:center;
  background:#f3f4f6;color:#111;border:1px solid var(--border);
  text-decoration:none;font-size:15px
}
.icon.whats{color:#16a34a}
.icon.mail{color:#2563eb}

/* MODAL */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;z-index:99
}
.modal .box{
  background:#fff;padding:22px;border-radius:22px;
  width:95%;max-width:900px;max-height:90vh;overflow:auto
}
.grid-form{
  display:grid;grid-template-columns:repeat(3,1fr);gap:10px
}
.grid-form label{font-size:11px;color:var(--muted)}
.grid-form input,.grid-form select,.grid-form textarea{
  width:100%;padding:10px;border-radius:12px;border:1px solid var(--border)
}
.grid-form input[readonly], .grid-form select[disabled]{
  background:#f3f4f6;color:#9ca3af;border-style:dashed
}
.footer-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
@media(max-width:900px){ .grid-form{grid-template-columns:1fr} }
</style>
</head>
<body>

<header class="header">
  <h1>Central Admin â€¢ SaaS Control</h1>
  <button class="btn primary" onclick="load()">Atualizar</button>
</header>

<div class="container">

  <div class="filters">
    <input id="f_busca" placeholder="Buscar nome, whatsapp, negÃ³cio, email..." oninput="render()">
    <select id="f_status" onchange="render()">
      <option value="">Status</option>
      <option value="active">Ativo</option>
      <option value="trial">Trial</option>
      <option value="expired">Expirado</option>
    </select>
    <select id="f_tipo" onchange="render()">
      <option value="">Tipo</option>
      <option value="LOJA">LOJA</option>
      <option value="BARBEARIA">BARBEARIA</option>
      <option value="STUDIO">STUDIO</option>
    </select>
  </div>

  <div class="grid" id="grid"></div>

</div>

<!-- MODAL EDITAR -->
<div class="modal" id="modal">
  <div class="box">
    <h3>Editar Loja (completo)</h3>
    <div class="grid-form" id="form"></div>
    <div class="footer-actions">
      <button class="btn" onclick="closeModal()">Cancelar</button>
      <button class="btn primary" onclick="salvar()">Salvar</button>
    </div>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

let data = [];
let current = null;

const SELECT_FIELDS = {
  status: ["active","trial","expired"],
  assinatura_plano: ["BASIC","MASTER"],
  assinatura_ativa: ["true","false"],
  pagamento_online_ativo: ["true","false"]
};
const LOCKED_FIELDS = ["id","user_id","pagamento_online_ativo"];

async function load(){
  const { data:rows } = await sb.from("user_profile").select("*").order("created_at",{ascending:false});
  data = rows || [];
  render();
}
load();

function render(){
  const busca = f_busca.value.toLowerCase();
  const status = f_status.value;
  const tipo = f_tipo.value;

  const list = data.filter(i=>{
    return (!busca || JSON.stringify(i).toLowerCase().includes(busca))
      && (!status || i.status===status)
      && (!tipo || i.tipo===tipo);
  });

  grid.innerHTML = list.map(i=>{
    const trialEnds = i.trial_ends_at ? new Date(i.trial_ends_at) : null;
    let diasTrial = trialEnds ? Math.ceil((trialEnds - new Date())/86400000) : null;
    if(diasTrial !== null && diasTrial < 0) diasTrial = 0;

    return `
    <div class="card">
      <div class="top">
        <img class="avatar" src="${i.avatar_url||'https://placehold.co/100x100?text=LOGO'}">
        <div>
          <div class="name">${i.responsavel||'-'}</div>
          <div class="city">${i.cidade||''} - ${i.uf||''}</div>
          <span class="badge ${i.status}">${i.status}</span>
        </div>
      </div>

      <div class="info"><b>${i.negocio||'-'}</b></div>
      <small>${i.tipo||'-'}</small>

      <div class="icons">
        ${i.whatsapp ? `<a class="icon whats" target="_blank" href="https://wa.me/55${i.whatsapp.replace(/\D/g,'')}"><i class="ri-whatsapp-line"></i></a>` : ``}
        ${i.email_contato ? `<a class="icon mail" href="mailto:${i.email_contato}"><i class="ri-mail-line"></i></a>` : ``}
      </div>

      <div class="row"><span class="muted">Plano</span><b>${i.assinatura_plano||'-'}</b></div>
      <div class="row"><span class="muted">Valor</span><b>R$ ${i.assinatura_valor||0}</b></div>
      <div class="row"><span class="muted">Validade</span><b>${i.assinatura_valida_ate ? new Date(i.assinatura_valida_ate).toLocaleDateString() : '-'}</b></div>

      <div class="row"><span class="muted">Trial</span><b>${trialEnds ? trialEnds.toLocaleDateString() : '-'}</b></div>
      <div class="row"><span class="muted">Dias</span>
        <b style="color:${diasTrial!==null && diasTrial<=3 ? '#dc2626':'#16a34a'}">${diasTrial!==null ? diasTrial : '-'}</b>
      </div>

      <div class="actions">
        <button class="btn" onclick='edit(${JSON.stringify(i)})'>Editar</button>
        ${!i.assinatura_ativa ? `<button class="btn warn" onclick="renovarTrial('${i.id}')">Trial</button>` : ``}
        <a class="btn primary" target="_blank" href="https://www.clena.com.br/loja.html?l=${i.user_id}">Abrir Loja</a>
      </div>
    </div>
    `;
  }).join("");
}

function edit(row){
  current = {...row};
  form.innerHTML = Object.keys(row).map(k=>{
    const isLocked = LOCKED_FIELDS.includes(k);
    const isSelect = SELECT_FIELDS[k];
    const value = (row[k] ?? "").toString();

    if(isSelect){
      const options = SELECT_FIELDS[k].map(v =>
        `<option value="${v}" ${value==v ? "selected":""}>${v}</option>`
      ).join("");
      return `
        <div>
          <label>${k}</label>
          <select ${isLocked ? "disabled":""} onchange="current['${k}']=this.value">
            ${options}
          </select>
        </div>
      `;
    }

    return `
      <div>
        <label>${k}</label>
        <input ${isLocked ? "readonly":""}
          value="${value.replaceAll('"','&quot;')}"
          onchange="current['${k}']=this.value">
      </div>
    `;
  }).join("");
  modal.style.display="flex";
}

function closeModal(){ modal.style.display="none"; }

async function salvar(){
  const payload = {...current};
  LOCKED_FIELDS.forEach(f => delete payload[f]);
  await sb.from("user_profile").update(payload).eq("id", current.id);
  closeModal();
  load();
}

async function renovarTrial(id){
  if(!confirm("Conceder +7 dias de trial?")) return;
  const novaData = new Date(Date.now() + 7*24*60*60*1000);
  await sb.from("user_profile").update({
    status:"trial",
    trial_ends_at:novaData,
    assinatura_ativa:false,
    assinatura_plano:null,
    assinatura_valor:null,
    assinatura_valida_ate:null
  }).eq("id",id);
  load();
}
</script>
</body>
</html>
