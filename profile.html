<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Central Admin ‚Ä¢ SaaS</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#ff6a00;
  --border:#e5e7eb;
  --radius:22px;
  --danger:#c62828;
  --muted:#6b7280;
  --bg:#0b0b0b;
  --card:#ffffff;
  --success:#16a34a;
  --warn:#f59e0b;
}
*{box-sizing:border-box;font-family:Inter;-webkit-tap-highlight-color:transparent}
body{margin:0;background:radial-gradient(900px 300px at 20% -10%,rgba(255,106,0,.15),transparent 40%),#000;color:#111}
.header{
  position:sticky;top:0;z-index:20;
  background:#fff;border-bottom:1px solid var(--border);
  padding:16px 20px;display:flex;align-items:center;justify-content:space-between
}
.header h1{margin:0;font-size:18px}
.container{max-width:1500px;margin:auto;padding:22px}
.kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:14px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:22px;padding:16px}
.kpi small{color:var(--muted)}
.kpi b{font-size:22px}
.filters{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.filters input,.filters select{
  padding:12px;border-radius:14px;border:1px solid var(--border)
}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
td{
  background:#fff;border:1px solid var(--border);
  padding:10px 12px;vertical-align:top
}
tr td:first-child{border-radius:16px 0 0 16px}
tr td:last-child{border-radius:0 16px 16px 0}
.badge{padding:5px 10px;border-radius:999px;font-size:11px;font-weight:800}
.active{background:#e8fff3;color:var(--success)}
.trial{background:#fff7ed;color:var(--primary)}
.expired{background:#ffe5e5;color:var(--danger)}
.btn{
  padding:8px 12px;border-radius:999px;border:1px solid var(--border);
  background:#fff;cursor:pointer;font-weight:800
}
.btn.primary{
  background:linear-gradient(135deg,#ff6a00,#ff9a57);
  border:none;color:#fff
}
.btn.warn{background:#fff7ed;color:#ff6a00;border:1px dashed #ff9a57}
.btn.danger{background:#ffe5e5;color:#c62828;border:none}
.avatar{width:38px;height:38px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
.meta{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:center;justify-content:center;z-index:50
}
.modal .box{
  background:#fff;padding:22px;border-radius:22px;
  width:95%;max-width:900px;max-height:90vh;overflow:auto
}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.grid input,.grid select,.grid textarea{
  width:100%;padding:10px;border-radius:12px;border:1px solid var(--border)
}
.footer-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
@media(max-width:900px){
  .kpis{grid-template-columns:1fr 1fr}
  .grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<header class="header">
  <h1>Central Admin ‚Ä¢ SaaS Control</h1>
  <button class="btn primary" onclick="load()">Atualizar</button>
</header>

<div class="container">

  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi"><small>Total</small><b id="k_total">0</b></div>
    <div class="kpi"><small>Ativos</small><b id="k_ativas">0</b></div>
    <div class="kpi"><small>Trials</small><b id="k_trial">0</b></div>
    <div class="kpi"><small>Expirados</small><b id="k_expirados">0</b></div>
    <div class="kpi"><small>MRR</small><b id="k_mrr">R$ 0,00</b></div>
  </div>

  <!-- Filtros -->
  <div class="filters">
    <input id="f_busca" placeholder="Buscar nome, whatsapp, neg√≥cio, email..." oninput="render()">
    <select id="f_status" onchange="render()">
      <option value="">Status</option>
      <option value="active">Ativo</option>
      <option value="trial">Trial</option>
      <option value="expired">Expirado</option>
    </select>
    <select id="f_plano" onchange="render()">
      <option value="">Plano</option>
      <option value="MASTER">MASTER</option>
      <option value="BASIC">BASIC</option>
    </select>
    <select id="f_tipo" onchange="render()">
      <option value="">Tipo</option>
      <option value="LOJA">LOJA</option>
      <option value="BARBEARIA">BARBEARIA</option>
      <option value="STUDIO">STUDIO</option>
    </select>
  </div>

  <!-- Tabela -->
  <table class="table">
    <thead>
      <tr>
        <th>Cliente</th>
        <th>Contato</th>
        <th>Neg√≥cio</th>
        <th>Status</th>
        <th>Assinatura</th>
        <th>Trial</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

</div>

<!-- Modal edi√ß√£o -->
<div class="modal" id="modal">
  <div class="box">
    <h3>Editar Cliente (Completo)</h3>
    <div class="grid" id="form"></div>
    <div class="footer-actions">
      <button class="btn" onclick="closeModal()">Cancelar</button>
      <button class="btn primary" onclick="salvar()">Salvar</button>
    </div>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

let data = [];
let current = null;

async function load(){
  const { data:rows } = await sb.from("user_profile").select("*").order("created_at",{ascending:false});
  data = rows || [];
  calcKpis();
  render();
}
load();

/* KPIs */
function calcKpis(){
  k_total.innerText = data.length;
  k_ativas.innerText = data.filter(i=>i.assinatura_ativa).length;
  k_trial.innerText = data.filter(i=>i.status==="trial").length;
  k_expirados.innerText = data.filter(i=>i.status==="expired").length;
  const mrr = data.reduce((s,i)=> s + (Number(i.assinatura_valor)||0),0);
  k_mrr.innerText = mrr.toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
}

/* Render */
function render(){
  const busca = f_busca.value.toLowerCase();
  const status = f_status.value;
  const plano = f_plano.value;
  const tipo = f_tipo.value;

  const list = data.filter(i=>{
    return (!busca || JSON.stringify(i).toLowerCase().includes(busca))
      && (!status || i.status===status)
      && (!plano || i.assinatura_plano===plano)
      && (!tipo || i.tipo===tipo);
  });

  tbody.innerHTML = list.map(i=>{
    const trialEnds = i.trial_ends_at ? new Date(i.trial_ends_at) : null;
    const diasTrial = trialEnds ? Math.ceil((trialEnds - new Date())/86400000) : null;

    return `
    <tr>
      <td>
        <img class="avatar" src="${i.avatar_url||''}">
        <div><b>${i.responsavel||"-"}</b></div>
        <div class="meta">${i.cidade||""} - ${i.uf||""}</div>
      </td>
      <td class="meta">
        üìß ${i.email_contato||"-"}<br>
        üì± ${i.whatsapp||"-"}
      </td>
      <td>
        <b>${i.negocio||"-"}</b><br>
        <span class="meta">${i.tipo||"-"}</span>
      </td>
      <td>
        <span class="badge ${i.status}">${i.status}</span><br>
        <span class="meta">${i.assinatura_ativa ? "Assinatura ativa" : "Sem assinatura"}</span>
      </td>
      <td class="meta">
        Plano: <b>${i.assinatura_plano||"-"}</b><br>
        Valor: <b>R$ ${i.assinatura_valor||0}</b><br>
        Validade: <b>${i.assinatura_valida_ate ? new Date(i.assinatura_valida_ate).toLocaleDateString() : "-"}</b>
      </td>
      <td class="meta">
        Fim: <b>${trialEnds ? trialEnds.toLocaleDateString() : "-"}</b><br>
        ${diasTrial !== null ? `Dias restantes: <b style="color:${diasTrial<=3?'#c62828':'#16a34a'}">${diasTrial}</b>` : "-"}
      </td>
      <td class="actions">
        <button class="btn" onclick='edit(${JSON.stringify(i)})'>Editar</button>
        <button class="btn warn" onclick='renovarTrial("${i.id}")'>Renovar trial</button>
        <a class="btn" target="_blank" href="/${i.slug}/${i.app_path||"app.html"}">Abrir App</a>
      </td>
    </tr>
    `;
  }).join("");
}

/* Modal */
function edit(row){
  current = row;
  form.innerHTML = Object.keys(row).map(k=>`
    <div>
      <label>${k}</label>
      <input value="${(row[k]??"").toString().replaceAll('"','&quot;')}"
        onchange="current['${k}']=this.value">
    </div>
  `).join("");
  modal.style.display="flex";
}
function closeModal(){ modal.style.display="none"; }
async function salvar(){
  await sb.from("user_profile").update(current).eq("id", current.id);
  closeModal();
  load();
}

/* üîÅ Renovar Trial (novo teste) */
async function renovarTrial(id){
  if(!confirm("Deseja conceder NOVO per√≠odo de teste por mais 7 dias?")) return;

  const novaData = new Date(Date.now() + 7*24*60*60*1000);

  await sb.from("user_profile").update({
    status: "trial",
    trial_ends_at: novaData,
    assinatura_ativa: false,
    assinatura_plano: null,
    assinatura_valor: null,
    assinatura_valida_ate: null
  }).eq("id", id);

  load();
}
</script>
</body>
</html>
