<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">

<title>Controle de Campos por Loja</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#2563eb;
  --bg:#f4f6fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
}

*{box-sizing:border-box;font-family:Inter}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  padding:24px;
}

h1{
  text-align:center;
  margin-bottom:24px;
}

.container{
  max-width:1200px;
  margin:auto;
  display:grid;
  gap:20px;
}

.card{
  background:var(--card);
  border-radius:20px;
  padding:20px;
  border:1px solid var(--border);
  box-shadow:0 12px 32px rgba(0,0,0,.06);
}

.grid{
  display:grid;
  gap:12px;
}
.cols-2{
  grid-template-columns:1fr 220px;
}

select,button{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid var(--border);
  font-weight:600;
  font-size:14px;
}

button{
  background:var(--primary);
  color:#fff;
  border:none;
  cursor:pointer;
}

button.outline{
  background:#fff;
  color:var(--text);
  border:1px solid var(--border);
}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:12px;
  border-bottom:1px solid var(--border);
  font-size:13px;
}
th{
  font-weight:800;
  text-align:left;
}

.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
}
.badge.loja{
  background:#dcfce7;
  color:#166534;
}

.actions{
  display:flex;
  gap:6px;
}
.actions button{
  padding:6px 10px;
  font-size:12px;
}

.empty{
  text-align:center;
  color:var(--muted);
  padding:20px;
}
</style>
</head>

<body>

<h1>Controle de Campos por Loja</h1>

<div class="container">

  <!-- SELEÇÃO DE LOJA -->
  <div class="card">
    <select id="selectLoja"></select>
  </div>

  <!-- ADICIONAR CAMPO -->
  <div class="card grid cols-2">
    <select id="selectCampo"></select>
    <button onclick="adicionarCampo()">Adicionar campo</button>
  </div>

  <!-- LISTA -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Campo</th>
          <th>Label</th>
          <th>Obrigatório</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="listaCampos"></tbody>
    </table>
  </div>

</div>

<script>
/* ==========================
   SUPABASE
========================== */
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "SUA_PUBLIC_ANON_KEY_AQUI"
);

/* ==========================
   ESTADO
========================== */
let lojaAtual = null;
let camposDisponiveis = [];
let camposAtivos = [];

/* ==========================
   INIT
========================== */
document.addEventListener("DOMContentLoaded", async () => {
  await carregarLojas();
  await carregarCamposCatalogo();
});

/* ==========================
   LOJAS
========================== */
async function carregarLojas(){
  const { data, error } = await sb
    .from("user_profile")
    .select("user_id, negocio")
    .order("negocio");

  if(error){
    console.error("Erro lojas", error);
    return;
  }

  const sel = document.getElementById("selectLoja");
  sel.innerHTML = `<option value="">Selecione a loja…</option>`;
  data.forEach(l=>{
    sel.innerHTML += `<option value="${l.user_id}">${l.negocio}</option>`;
  });

  sel.onchange = () => {
    lojaAtual = sel.value;
    if(lojaAtual) carregarCamposLoja();
  };
}

/* ==========================
   CATÁLOGO
========================== */
async function carregarCamposCatalogo(){
  const { data, error } = await sb
    .from("campos_cadastro")
    .select("*")
    .order("label");

  if(error){
    console.error("Erro catálogo", error);
    return;
  }

  camposDisponiveis = data;

  const sel = document.getElementById("selectCampo");
  sel.innerHTML = `<option value="">Adicionar campo…</option>`;
  data.forEach(c=>{
    sel.innerHTML += `<option value="${c.id}">${c.label}</option>`;
  });
}

/* ==========================
   CAMPOS DA LOJA
========================== */
async function carregarCamposLoja(){
  const { data, error } = await sb
    .from("vw_campos_por_loja")
    .select("*")
    .eq("user_id", lojaAtual)
    .order("ordem");

  if(error){
    console.error("Erro campos loja", error);
    return;
  }

  camposAtivos = data;
  render();
}

/* ==========================
   RENDER
========================== */
function render(){
  const tbody = document.getElementById("listaCampos");
  tbody.innerHTML = "";

  if(camposAtivos.length === 0){
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="empty">
          Nenhum campo ativo para esta loja
        </td>
      </tr>`;
    return;
  }

  camposAtivos.forEach(c=>{
    tbody.innerHTML += `
      <tr>
        <td>${c.campo}</td>
        <td>${c.label}</td>
        <td>${c.obrigatorio ? "Sim" : "Não"}</td>
        <td class="actions">
          <button class="outline" onclick="toggleObrigatorio('${c.campo_id}', ${c.obrigatorio})">
            Obr.
          </button>
          <button class="outline" onclick="removerCampo('${c.campo_id}')">
            Remover
          </button>
        </td>
      </tr>
    `;
  });
}

/* ==========================
   AÇÕES
========================== */
async function adicionarCampo(){
  if(!lojaAtual) return alert("Selecione a loja");
  const campoId = document.getElementById("selectCampo").value;
  if(!campoId) return;

  const { error } = await sb
    .from("campos_por_loja")
    .upsert({
      user_id: lojaAtual,
      campo_id: campoId,
      ativo: true
    });

  if(error){
    console.error("Erro adicionar", error);
    alert("Erro ao adicionar campo");
    return;
  }

  carregarCamposLoja();
}

async function toggleObrigatorio(campoId, atual){
  const { error } = await sb
    .from("campos_por_loja")
    .update({ obrigatorio: !atual })
    .eq("user_id", lojaAtual)
    .eq("campo_id", campoId);

  if(error){
    console.error("Erro obrigatório", error);
    return;
  }

  carregarCamposLoja();
}

async function removerCampo(campoId){
  if(!confirm("Remover campo da loja?")) return;

  const { error } = await sb
    .from("campos_por_loja")
    .update({ ativo:false })
    .eq("user_id", lojaAtual)
    .eq("campo_id", campoId);

  if(error){
    console.error("Erro remover", error);
    return;
  }

  carregarCamposLoja();
}
</script>

</body>
</html>
