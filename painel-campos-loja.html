<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Controle de Campos por Loja</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Inter, Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 40px;
}

h1 {
  margin-bottom: 20px;
}

.card {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 10px 25px rgba(0,0,0,.08);
  margin-bottom: 20px;
}

select, button {
  padding: 12px;
  font-size: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button {
  background: #2563eb;
  color: #fff;
  cursor: pointer;
  border: none;
}

button:hover {
  opacity: .9;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 12px;
  border-bottom: 1px solid #eee;
}

th {
  text-align: left;
}
</style>
</head>

<body>

<h1>Controle de Campos por Loja</h1>

<div class="card">
  <label>Loja</label><br><br>
  <select id="lojaSelect"></select>
</div>

<div class="card">
  <label>Adicionar campo</label><br><br>
  <select id="campoSelect"></select>
  <button onclick="adicionarCampo()">Adicionar</button>
</div>

<div class="card">
  <table>
    <thead>
      <tr>
        <th>Campo</th>
        <th>Label</th>
        <th>Obrigatório</th>
        <th>Ativo</th>
      </tr>
    </thead>
    <tbody id="tabelaCampos">
      <tr><td colspan="4">Selecione uma loja</td></tr>
    </tbody>
  </table>
</div>

<script>
/* =========================
   CONFIG SUPABASE
========================= */
const supabase = supabase.createClient(
  "https://SEU_PROJETO.supabase.co",
  "SUA_PUBLIC_ANON_KEY"
);

/* =========================
   ELEMENTOS
========================= */
const lojaSelect = document.getElementById("lojaSelect");
const campoSelect = document.getElementById("campoSelect");
const tabela = document.getElementById("tabelaCampos");

/* =========================
   LOAD INICIAL
========================= */
carregarLojas();
carregarCampos();

/* =========================
   FUNÇÕES
========================= */
async function carregarLojas() {
  const { data, error } = await supabase
    .from("user_profile")
    .select("id, nome")
    .order("nome");

  if (error) {
    console.error("Erro lojas:", error);
    return;
  }

  lojaSelect.innerHTML = `<option value="">Selecione</option>`;
  data.forEach(l => {
    lojaSelect.innerHTML += `<option value="${l.id}">${l.nome}</option>`;
  });
}

async function carregarCampos() {
  const { data, error } = await supabase
    .from("campos_cadastro")
    .select("id, label")
    .order("label");

  if (error) {
    console.error("Erro campos:", error);
    return;
  }

  campoSelect.innerHTML = `<option value="">Selecione</option>`;
  data.forEach(c => {
    campoSelect.innerHTML += `<option value="${c.id}">${c.label}</option>`;
  });
}

lojaSelect.addEventListener("change", carregarCamposDaLoja);

async function carregarCamposDaLoja() {
  const lojaId = lojaSelect.value;
  if (!lojaId) return;

  const { data, error } = await supabase
    .from("campos_por_loja")
    .select(`
      id,
      obrigatorio,
      ativo,
      campos_cadastro ( label )
    `)
    .eq("user_id", lojaId)
    .order("ordem");

  if (error) {
    console.error("Erro campos loja:", error);
    return;
  }

  tabela.innerHTML = "";

  if (!data.length) {
    tabela.innerHTML = `<tr><td colspan="4">Nenhum campo ativo</td></tr>`;
    return;
  }

  data.forEach(r => {
    tabela.innerHTML += `
      <tr>
        <td>${r.campos_cadastro.label}</td>
        <td>${r.campos_cadastro.label}</td>
        <td>${r.obrigatorio ? "Sim" : "Não"}</td>
        <td>${r.ativo ? "Ativo" : "Inativo"}</td>
      </tr>
    `;
  });
}

async function adicionarCampo() {
  const lojaId = lojaSelect.value;
  const campoId = campoSelect.value;

  if (!lojaId || !campoId) {
    alert("Selecione loja e campo");
    return;
  }

  const { error } = await supabase
    .from("campos_por_loja")
    .insert({
      user_id: lojaId,
      campo_id: campoId,
      obrigatorio: false,
      ativo: true,
      ordem: 999
    });

  if (error) {
    console.error("Erro insert:", error);
    alert("Erro ao adicionar");
    return;
  }

  carregarCamposDaLoja();
}
</script>

</body>
</html>
