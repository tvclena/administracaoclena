<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">

<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover">

<meta name="theme-color" content="#2563eb">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#2563eb;
  --bg:#f4f6fb;
  --card:#ffffff;
  --border:#e5e7eb;
  --text:#111827;
  --muted:#6b7280;
}

*{box-sizing:border-box;font-family:Inter}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  padding:24px;
}

.header{text-align:center;margin-bottom:24px}
.header h1{font-size:22px;font-weight:900}

.container{max-width:1200px;margin:auto;display:grid;gap:20px}

.card{
  background:var(--card);
  border-radius:22px;
  padding:20px;
  border:1px solid var(--border);
  box-shadow:0 12px 34px rgba(0,0,0,.06);
}

.grid{display:grid;gap:14px}
.cols-2{grid-template-columns:1fr 1fr}

select,button{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid var(--border);
  font-weight:600;
  font-size:14px;
}

button{
  background:var(--primary);
  color:#fff;
  border:none;
  cursor:pointer;
}

table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid var(--border);font-size:13px}
th{font-weight:800}

.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  font-weight:800;
}
.tipo{background:#e0f2fe;color:#0369a1}
.loja{background:#dcfce7;color:#166534}

.actions{display:flex;gap:6px}
.actions button{
  padding:6px 10px;
  font-size:12px;
  border-radius:10px;
}
</style>
</head>

<body>

<div class="header">
  <h1>Controle de Campos por Loja</h1>
</div>

<div class="container">

<!-- LOJA -->
<div class="card">
  <select id="selectLoja">
    <option value="">Selecione uma loja…</option>
  </select>
</div>

<!-- ADICIONAR -->
<div class="card grid cols-2">
  <select id="campoNovo">
    <option value="">Adicionar campo…</option>
  </select>
  <button id="btnAdd">Adicionar campo à loja</button>
</div>

<!-- LISTA -->
<div class="card">
<table>
<thead>
<tr>
  <th>Campo</th>
  <th>Label</th>
  <th>Origem</th>
  <th>Obrigatório</th>
  <th>Ações</th>
</tr>
</thead>
<tbody id="listaCampos">
<tr><td reminding colspan="5" style="text-align:center;color:#6b7280">
  Selecione uma loja
</td></tr>
</tbody>
</table>
</div>

</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

/* ================= STATE ================= */
let lojaAtual = null;
let camposDisponiveis = [];

/* ================= INIT ================= */
(async()=>{
  await carregarLojas();
  await carregarCamposCadastro();
})();

/* ================= LOJAS ================= */
async function carregarLojas(){
  const { data } = await sb
    .from("user_profile")
    .select("user_id, negocio")
    .eq("status","active")
    .order("negocio");

  selectLoja.innerHTML += data.map(l =>
    `<option value="${l.user_id}">${l.negocio}</option>`
  ).join("");
}

selectLoja.addEventListener("change",()=>{
  lojaAtual = selectLoja.value;
  if(lojaAtual) carregarCamposLoja();
});

/* ================= CAMPOS BASE ================= */
async function carregarCamposCadastro(){
  const { data } = await sb
    .from("campos_cadastro")
    .select("id,label")
    .order("label");

  camposDisponiveis = data || [];
  renderSelectCampos();
}

function renderSelectCampos(usados=[]){
  campoNovo.innerHTML = `<option value="">Adicionar campo…</option>` +
    camposDisponiveis
      .filter(c=>!usados.includes(c.id))
      .map(c=>`<option value="${c.id}">${c.label}</option>`)
      .join("");
}

/* ================= CAMPOS DA LOJA ================= */
async function carregarCamposLoja(){
  const { data } = await sb
    .from("campos_cadastro_por_loja")
    .select("*")
    .eq("user_id", lojaAtual)
    .order("ordem");

  renderTabela(data || []);
  renderSelectCampos((data||[]).map(c=>c.campo_id));
}

function renderTabela(lista){
  if(!lista.length){
    listaCampos.innerHTML = `
      <tr>
        <td colspan="5" style="text-align:center;color:#6b7280">
          Nenhum campo ativo para esta loja
        </td>
      </tr>`;
    return;
  }

  listaCampos.innerHTML = lista.map(c=>`
    <tr>
      <td>${c.campo}</td>
      <td>${c.label}</td>
      <td>
        <span class="badge ${c.origem==='loja'?'loja':'tipo'}">
          ${c.origem==='loja'?'Loja':'Tipo'}
        </span>
      </td>
      <td>${c.obrigatorio ? 'Sim' : 'Não'}</td>
      <td class="actions">
        <button onclick="toggleObrigatorio('${c.campo_id}',${c.obrigatorio})">Obrig.</button>
        <button onclick="removerCampo('${c.campo_id}')">Remover</button>
      </td>
    </tr>
  `).join("");
}

/* ================= ACTIONS ================= */
btnAdd.onclick = async ()=>{
  if(!lojaAtual || !campoNovo.value) return;

  await sb.from("campos_por_loja").insert({
    user_id: lojaAtual,
    campo_id: campoNovo.value,
    obrigatorio: false,
    ativo: true,
    origem: 'loja',
    ordem: 0
  });

  carregarCamposLoja();
};

async function toggleObrigatorio(campoId, atual){
  await sb.from("campos_por_loja")
    .update({ obrigatorio: !atual })
    .eq("user_id", lojaAtual)
    .eq("campo_id", campoId);

  carregarCamposLoja();
}

async function removerCampo(campoId){
  await sb.from("campos_por_loja")
    .update({ ativo:false })
    .eq("user_id", lojaAtual)
    .eq("campo_id", campoId);

  carregarCamposLoja();
}
</script>

</body>
</html>
